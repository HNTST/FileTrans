<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  </head>
  <body>
    <h2 id="welcome">–û—Ç—Å–æ—Å–∏ —Ö—É–π, <span id="user-login"></span></h2>
    <button onclick="logout()" style="margin: -top 10px">–í—ã–π—Ç–∏</button>

    <input type="file" id="file-input" />
    <input type="hidden" id="user-uuid" />
    <button onclick="uploadFile()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>

    <div id="progress-container" style="margin-top: 10px; display: none">
      <progress id="progress-bar" value="0" max="100"></progress>
      <span id="progress-text">0%</span>
    </div>

    <div id="upload-result" style="margin-top: 10px"></div>

    <hr />

    <h3>–ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–π–ª–∞–º</h3>
    <input
      type="text"
      id="search-input"
      placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞..."
      oninput="filterFiles()"
    />

    <h3>–í–∞—à–∏ —Ñ–∞–π–ª—ã:</h3>
    <ul id="files-list"></ul>

    <script>
      const userLogin = localStorage.getItem("userLogin");
      const userUuid = localStorage.getItem("userUuid");

      if (!userLogin || !userUuid) {
        alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã");
        window.location.href = "/";
        throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage");
      }

      document.getElementById("user-login").innerText = userLogin;
      document.getElementById("user-uuid").value = userUuid;

      function uploadFile() {
        const fileInput = document.getElementById("file-input");
        const uuid = document.getElementById("user-uuid").value;
        const resultDiv = document.getElementById("upload-result");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");
        const progressContainer = document.getElementById("progress-container");

        const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100 MB

        if (!fileInput.files.length) {
          alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");
          return;
        }

        const file = fileInput.files[0];
        if (file.size > MAX_FILE_SIZE) {
          resultDiv.innerHTML = `<span style="color: red;">‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 100 –ú–ë</span>`;
          return;
        }
        const formData = new FormData();
        formData.append("file", file);
        formData.append("userUuid", uuid);

        resultDiv.innerHTML = "";
        progressContainer.style.display = "block";
        progressBar.value = 0;
        progressText.textContent = "0%";

        const xhr = new XMLHttpRequest();

        xhr.upload.onprogress = function (event) {
          if (event.lengthComputable) {
            const percentComplete = Math.round(
              (event.loaded / event.total) * 100
            );
            progressBar.value = percentComplete;
            progressText.textContent = percentComplete + "%";
          }
        };

        xhr.onload = function () {
          progressContainer.style.display = "none";
          if (xhr.status === 200) {
            try {
              const response = JSON.parse(xhr.responseText);
              resultDiv.innerHTML = `<span style="color: green;">‚úÖ ${response.message}</span>`;
              loadUserFiles();
            } catch (e) {
              resultDiv.innerHTML = `<span style="color: red;">‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞</span>`;
            }
          } else {
            resultDiv.innerHTML = `<span style="color: red;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${xhr.statusText}</span>`;
          }
        };

        xhr.onerror = function () {
          progressContainer.style.display = "none";
          resultDiv.innerHTML = `<span style="color: red;">‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞</span>`;
        };

        xhr.open("POST", "/upload", true);
        xhr.send(formData);
      }

      let allFiles = []; // —Ö—Ä–Ω–∏–ª–∏—â–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤

      window.onload = loadUserFiles; // —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

      async function loadUserFiles() {
        const resultDiv = document.getElementById("upload-result");
        resultDiv.innerHTML = "";

        const login = localStorage.getItem("userLogin");

        if (!login) {
          alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã");
          window.location.href = "/";
          return;
        }

        const response = await fetch("/usersFiles", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ login }),
        });

        if (!response.ok) {
          alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤");
          return;
        }

        const files = await response.json();

        if (!Array.isArray(files)) {
          document.getElementById("files-list").innerHTML =
            "<li>–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</li>";
          allFiles = [];
          return;
        }

        allFiles = files;

        displayFiles(allFiles);
      }

      // –ø–æ–∫–∞–∂–∏ –º–Ω–µ —Ñ–∞–π–ª—ã —Å—É—á–∫–∞
      function displayFiles(files) {
        const list = document.getElementById("files-list");
        list.innerHTML = "";

        if (files.length === 0) {
          list.innerHTML = "<li>–§–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</li>";
          return;
        }

        for (const file of files) {
          const li = createFileListItem(file);
          list.appendChild(li);
        }
      }

      // —ç–ª–µ–º–µ–Ω—Ç —Ñ–∞–π–ª–∞
      function createFileListItem(file) {
        const li = document.createElement("li");
        const downloadLink = `/download/${file.uuid}`;

        li.innerHTML = `
        ${file.fileName || file.file_name}
        <br>
        <a href="${downloadLink}" target="_blank">üìÅ –°–∫–∞—á–∞—Ç—å</a>
        &nbsp;|&nbsp;
        <button onclick="deleteFile('${file.uuid}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
    `;

        return li;
      }

      // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–π–ª–∞
      function filterFiles() {
        const searchInput = document.getElementById("search-input");
        const query = searchInput.value.toLowerCase().trim();

        if (!query) {
          displayFiles(allFiles); // –µ—Å–ª–∏ –ø—É—Å—Ç–æ–π –ø–æ–∏—Å–∫
          return;
        }

        const filtered = allFiles.filter((file) => {
          const name = (file.fileName || file.file_name).toLowerCase();
          return name.includes(query);
        });

        displayFiles(filtered);
      }

      async function deleteFile(uuid) {
        const confirmDelete = confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?");
        if (!confirmDelete) return;

        const response = await fetch(`/delete-file/${uuid}`, {
          method: "DELETE",
        });

        if (response.ok) {
          alert("‚úÖ –§–∞–π–ª —É–¥–∞–ª–µ–Ω");
          loadUserFiles(); // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        } else {
          alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞");
        }
      }

      function copyLink(link) {
        navigator.clipboard.writeText(link).then(
          () => {
            alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: " + link);
          },
          () => {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É");
          }
        );
      }

      window.onload = loadUserFiles;
      function logout() {
        localStorage.removeItem("userLogin");
        localStorage.removeItem("userUuid");
        window.location.href = "http://localhost:8080/";
      }

      const REFRESH_INTERVAL = 5000; // 5 —Å–µ–∫—É–Ω–¥

      document.addEventListener("DOMContentLoaded", () => {
        loadUserFiles(); // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setInterval(loadUserFiles, REFRESH_INTERVAL); // –¥–∞–ª–µ–µ –ø–æ —Ç–∞–π–º–µ—Ä—É
      });
    </script>
  </body>
</html>
